# UniTab 自动同步策略设计

## 概述

本文档定义了 UniTab 插件的完整自动同步策略，确保用户数据在各种场景下都能及时、可靠地与远程存储保持同步。

## 同步触发场景

### 1. 浏览器生命周期事件

#### 1.1 浏览器启动时
- **触发时机**: 浏览器启动后，Service Worker 激活时
- **同步策略**: 检查上次同步时间，如果超过阈值则自动同步
- **实现位置**: `background.ts` 中的 `chrome.runtime.onStartup` 事件
- **同步类型**: 双向同步（先拉取远程数据，再推送本地更改）

#### 1.2 插件安装/更新时
- **触发时机**: 插件首次安装或版本更新时
- **同步策略**: 如果已配置同步，立即执行一次完整同步
- **实现位置**: `background.ts` 中的 `chrome.runtime.onInstalled` 事件
- **同步类型**: 双向同步

### 2. 页面加载事件

#### 2.1 首次打开 popup.html
- **触发时机**: 用户点击插件图标，popup 页面加载时
- **同步策略**: 检查距离上次同步的时间间隔，超过阈值则后台同步
- **实现位置**: `popup/App.tsx` 的 `useEffect`
- **同步类型**: 拉取同步（优先显示最新数据）
- **用户体验**: 不阻塞 UI，后台静默同步

#### 2.2 首次打开 tab_list.html
- **触发时机**: 用户打开标签页管理页面时
- **同步策略**: 页面加载完成后立即检查同步状态
- **实现位置**: `tab_list/App.tsx` 的 `useEffect`
- **同步类型**: 双向同步
- **用户体验**: 显示同步状态指示器

#### 2.3 首次打开 options.html
- **触发时机**: 用户打开设置页面时
- **同步策略**: 检查同步配置状态，如果已配置则同步
- **实现位置**: `options/App.tsx` 的 `useEffect`
- **同步类型**: 拉取同步

### 3. 用户操作事件

#### 3.1 数据修改后
- **触发时机**: 用户创建、删除、修改分组或标签页后
- **同步策略**: 延迟同步（防抖处理，避免频繁同步）
- **实现位置**: 各个数据修改操作的回调中
- **同步类型**: 推送同步
- **延迟时间**: 5秒（可配置）

#### 3.2 手动同步
- **触发时机**: 用户点击同步按钮
- **同步策略**: 立即执行完整同步
- **实现位置**: 同步设置面板
- **同步类型**: 双向同步
- **用户体验**: 显示同步进度和结果

### 4. 定时同步

#### 4.1 页面活跃时的定时同步
- **触发时机**: 页面保持打开状态时的定时检查
- **同步策略**: 每30分钟检查一次，如果有远程更新则同步
- **实现位置**: 各页面的定时器
- **同步类型**: 拉取同步
- **条件**: 页面可见且用户活跃

#### 4.2 后台定时同步
- **触发时机**: Service Worker 中的定时任务
- **同步策略**: 每2小时执行一次后台同步
- **实现位置**: `background.ts` 中的 `chrome.alarms` API
- **同步类型**: 双向同步
- **条件**: 已配置同步且网络可用

### 5. 网络状态变化

#### 5.1 网络恢复时
- **触发时机**: 从离线状态恢复到在线状态
- **同步策略**: 立即执行一次完整同步
- **实现位置**: 监听 `navigator.onLine` 事件
- **同步类型**: 双向同步

#### 5.2 网络断开时
- **触发时机**: 检测到网络断开
- **同步策略**: 停止所有同步操作，缓存待同步数据
- **实现位置**: 网络状态监听器
- **处理方式**: 本地缓存修改，等待网络恢复

## 同步策略配置

### 时间阈值配置
```typescript
interface SyncConfig {
  // 启动时同步阈值（毫秒）
  startupSyncThreshold: number; // 默认: 1小时
  
  // 页面加载同步阈值（毫秒）
  pageLoadSyncThreshold: number; // 默认: 30分钟
  
  // 数据修改后延迟同步时间（毫秒）
  dataChangeDelaySync: number; // 默认: 5秒
  
  // 定时同步间隔（毫秒）
  periodicSyncInterval: number; // 默认: 30分钟
  
  // 后台同步间隔（毫秒）
  backgroundSyncInterval: number; // 默认: 2小时
  
  // 最大重试次数
  maxRetryCount: number; // 默认: 3
  
  // 重试间隔（毫秒）
  retryInterval: number; // 默认: 30秒
}
```

### 同步优先级
1. **高优先级**: 手动同步、数据修改后同步
2. **中优先级**: 页面加载同步、网络恢复同步
3. **低优先级**: 定时同步、后台同步

## 冲突处理策略

### 数据冲突解决
1. **时间戳优先**: 以最新修改时间为准
2. **用户选择**: 对于重要冲突，提示用户选择
3. **合并策略**: 对于可合并的数据（如标签页列表），尝试智能合并

### 同步状态管理
- **空闲状态**: 无同步操作进行
- **同步中**: 正在执行同步操作
- **成功状态**: 同步完成且成功
- **错误状态**: 同步失败，显示错误信息
- **冲突状态**: 存在数据冲突，需要用户处理

## 性能优化

### 1. 增量同步
- 只同步有变化的数据
- 使用数据指纹（hash）检测变化
- 减少网络传输量

### 2. 批量操作
- 将多个小的修改合并为一次同步
- 使用防抖机制避免频繁同步
- 优化 API 调用次数

### 3. 缓存策略
- 本地缓存远程数据状态
- 智能判断是否需要同步
- 减少不必要的网络请求

## 错误处理

### 网络错误
- 自动重试机制
- 指数退避策略
- 离线模式支持

### 认证错误
- Token 过期自动刷新
- 重新认证提示
- 降级到本地模式

### 数据错误
- 数据校验和修复
- 备份和恢复机制
- 错误日志记录

## 用户体验设计

### 同步状态指示
- 实时显示同步状态
- 进度条显示同步进度
- 成功/失败状态反馈

### 用户控制
- 允许用户暂停/恢复同步
- 提供手动同步选项
- 同步设置可配置

### 性能影响最小化
- 后台静默同步
- 不阻塞用户操作
- 智能调度同步任务

## 实现计划

### 第一阶段：基础同步机制
1. 实现 Service Worker 中的启动同步
2. 添加页面加载时的同步检查
3. 完善同步状态管理

### 第二阶段：智能同步
1. 实现数据修改后的延迟同步
2. 添加定时同步机制
3. 网络状态监听和处理

### 第三阶段：优化和完善
1. 增量同步实现
2. 冲突处理机制
3. 性能优化和用户体验提升

## 配置示例

```typescript
// 默认同步配置
const DEFAULT_SYNC_CONFIG: SyncConfig = {
  startupSyncThreshold: 60 * 60 * 1000, // 1小时
  pageLoadSyncThreshold: 30 * 60 * 1000, // 30分钟
  dataChangeDelaySync: 5 * 1000, // 5秒
  periodicSyncInterval: 30 * 60 * 1000, // 30分钟
  backgroundSyncInterval: 2 * 60 * 60 * 1000, // 2小时
  maxRetryCount: 3,
  retryInterval: 30 * 1000 // 30秒
};
```

这套同步策略确保了数据的及时性、一致性和可靠性，同时最大化用户体验和性能表现。